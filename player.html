<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>IPTV Player</title>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#fff;font-family:'Segoe UI',sans-serif;display:flex;height:100vh;overflow:hidden}
#sidebar{width:300px;background:#0d0d0d;display:flex;flex-direction:column;border-right:1px solid #1a1a1a;flex-shrink:0}
#sidebar-header{padding:14px 16px;background:#0d0d0d;border-bottom:1px solid #1a1a1a;flex-shrink:0}
#sidebar-header h2{font-size:1.1rem;color:#e94560;letter-spacing:1px;margin-bottom:8px}
#search-input{width:100%;padding:8px 12px;background:#111;border:1px solid #222;border-radius:8px;color:#fff;font-size:.82rem;outline:none}
#search-input:focus{border-color:#e94560}
#cat-tabs{display:flex;overflow-x:auto;padding:8px 10px;gap:6px;border-bottom:1px solid #1a1a1a;flex-shrink:0}
#cat-tabs::-webkit-scrollbar{height:3px}
#cat-tabs::-webkit-scrollbar-thumb{background:#e94560;border-radius:2px}
.cat-btn{background:#111;border:1px solid #222;color:#888;padding:4px 12px;border-radius:20px;font-size:.72rem;cursor:pointer;white-space:nowrap;transition:all .2s}
.cat-btn:hover,.cat-btn.active{background:#e94560;border-color:#e94560;color:#fff}
#channel-list{flex:1;overflow-y:auto;padding:6px}
#channel-list::-webkit-scrollbar{width:4px}
#channel-list::-webkit-scrollbar-thumb{background:#e94560;border-radius:2px}
.channel-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:background .2s;margin-bottom:2px}
.channel-item:hover{background:#1a1a2e}
.channel-item.active{background:#e94560}
.channel-logo{width:34px;height:34px;border-radius:6px;object-fit:contain;background:#111;flex-shrink:0}
.no-logo{width:34px;height:34px;border-radius:6px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.ch-name{font-size:.83rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ch-cat{font-size:.68rem;color:#aaa}
.channel-item.active .ch-cat{color:#ffcccc}
.empty-msg{color:#444;font-size:.82rem;text-align:center;padding:20px 10px}
#right{flex:1;display:flex;flex-direction:column;overflow:hidden}
#player-screen{position:relative;flex:1;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
video{width:100%;height:100%;object-fit:contain;background:#000}
#channel-overlay{position:absolute;top:14px;left:14px;background:rgba(0,0,0,.7);padding:5px 14px;border-radius:20px;font-size:.88rem;font-weight:600;pointer-events:none;z-index:10}
#status-badge{position:absolute;top:14px;right:14px;display:flex;align-items:center;gap:6px;background:rgba(0,0,0,.7);padding:5px 12px;border-radius:20px;font-size:.75rem;pointer-events:none;z-index:10}
.sdot{width:8px;height:8px;border-radius:50%;background:#555;flex-shrink:0}
.sdot.live{background:#e94560;animation:pulse 1.2s infinite}
.sdot.loading{background:#f0a500;animation:pulse .6s infinite}
.sdot.error{background:#cc3333}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
#controls{background:#0d0d0d;border-top:1px solid #1a1a1a;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-shrink:0;flex-wrap:wrap}
#now-playing{flex:1;min-width:0}
#now-playing .np-name{font-size:.9rem;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
#now-playing .np-cat{font-size:.72rem;color:#888}
#ctrl-buttons{display:flex;gap:8px;flex-wrap:wrap}
.ctrl-btn{background:#1a1a1a;border:1px solid #2a2a2a;color:#ccc;padding:8px 16px;border-radius:8px;font-size:.8rem;cursor:pointer;transition:all .2s;white-space:nowrap}
.ctrl-btn:hover{background:#e94560;border-color:#e94560;color:#fff}
.focused{outline:2px solid #e94560 !important;background:#1e2a4a !important}
.channel-item.active.focused{background:#c73652 !important}
@media(max-width:800px){body{flex-direction:column}#sidebar{width:100%;height:240px;border-right:none;border-bottom:1px solid #1a1a1a}#controls{justify-content:center}}
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <h2>üì∫ IPTV Player</h2>
    <input type="text" id="search-input" placeholder="üîç Cerca canale..." oninput="doSearch()"/>
  </div>
  <div id="cat-tabs"></div>
  <div id="channel-list"><p class="empty-msg">‚è≥ Caricamento canali...</p></div>
</div>

<div id="right">
  <div id="player-screen">
    <video id="video" controls autoplay playsinline></video>
    <div id="channel-overlay">üì∫ Nessun canale selezionato</div>
    <div id="status-badge">
      <div class="sdot loading" id="sdot"></div>
      <span id="stext">Caricamento lista...</span>
    </div>
  </div>
  <div id="controls">
    <div id="now-playing">
      <div class="np-name" id="np-name">Nessun canale</div>
      <div class="np-cat" id="np-cat">Seleziona un canale dalla lista</div>
    </div>
    <div id="ctrl-buttons">
      <button class="ctrl-btn" onclick="prevChannel()">‚èÆ Prec</button>
      <button class="ctrl-btn" onclick="nextChannel()">‚è≠ Succ</button>
      <button class="ctrl-btn" onclick="muteToggle()" id="mute-btn">üîá Muto</button>
      <button class="ctrl-btn" onclick="reloadStream()">üîÑ Ricarica</button>
      <button class="ctrl-btn" onclick="openFullscreen()">‚õ∂ Fullscreen</button>
    </div>
  </div>
</div>

<script>
let channels = [];
let currentIndex = -1;
let currentCategory = "Tutti";
let hlsInstance = null;
let searchMode = false;
let focusedIndex = -1;
let focusableItems = [];

window.addEventListener("load", loadM3U);

function loadM3U() {
  setStatus("loading", "Caricamento lista...");
  fetch("ita.m3u?" + Date.now())
    .then(r => { if (!r.ok) throw new Error("HTTP " + r.status); return r.text(); })
    .then(text => {
      if (!text.includes("#EXTM3U")) throw new Error("File non valido");
      parseM3U(text);
      setStatus("live", channels.length + " canali pronti");
    })
    .catch(err => {
      setStatus("error", "Errore: " + err.message);
      document.getElementById("channel-list").innerHTML = '<p class="empty-msg">‚ùå ' + err.message + '</p>';
    });
}

function parseM3U(text) {
  channels = [];
  const lines = text.split("\n").map(l => l.trim()).filter(l => l);
  let cur = null;
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    if (line.startsWith("#EXTINF")) {
      cur = { name: "", category: "Generale", logo: "", url: "" };
      cur.name = line.split(",").slice(-1)[0].trim();
      const lg = line.match(/tvg-logo="([^"]*)"/); if (lg) cur.logo = lg[1];
      const gr = line.match(/group-title="([^"]*)"/); if (gr && gr[1].trim()) cur.category = gr[1].trim();
    } else if (cur && !line.startsWith("#")) {
      cur.url = line;
      if (cur.name && cur.url) channels.push(cur);
      cur = null;
    }
  }
  const ordineCategorie = ["General","Entertainment","News","Sports","Movies","Kids","Music","Documentary","Religious","Undefined"];
  channels.sort((a, b) => {
    const iA = ordineCategorie.findIndex(c => a.category.toLowerCase().includes(c.toLowerCase()));
    const iB = ordineCategorie.findIndex(c => b.category.toLowerCase().includes(c.toLowerCase()));
    const orderA = iA === -1 ? 999 : iA;
    const orderB = iB === -1 ? 999 : iB;
    if (orderA !== orderB) return orderA - orderB;
    if (a.category !== b.category) return a.category.localeCompare(b.category);
    return a.name.localeCompare(b.name);
  });
  currentIndex = -1;
  currentCategory = "Tutti";
  renderCategoryTabs();
  renderChannels();
}

function getCategories() {
  return ["Tutti", ...new Set(channels.map(c => c.category))];
}

function renderCategoryTabs() {
  const tabs = document.getElementById("cat-tabs");
  tabs.innerHTML = "";
  getCategories().forEach(cat => {
    const btn = document.createElement("button");
    btn.className = "cat-btn" + (cat === currentCategory ? " active" : "");
    btn.textContent = cat;
    btn.onclick = () => {
      currentCategory = cat;
      searchMode = false;
      document.getElementById("search-input").value = "";
      renderCategoryTabs();
      renderChannels();
    };
    tabs.appendChild(btn);
  });
}

function renderChannels() {
  const list = document.getElementById("channel-list");
  list.innerHTML = "";
  const filtered = channels.filter(c => currentCategory === "Tutti" || c.category === currentCategory);
  if (filtered.length === 0) { list.innerHTML = '<p class="empty-msg">Nessun canale.</p>'; return; }
  filtered.forEach(ch => {
    const ri = channels.indexOf(ch);
    list.appendChild(makeItem(ch, ri));
  });
}

function doSearch() {
  const q = document.getElementById("search-input").value.toLowerCase().trim();
  const list = document.getElementById("channel-list");
  list.innerHTML = "";
  if (!q) { renderChannels(); return; }
  const filtered = channels.filter(c => c.name.toLowerCase().includes(q));
  if (filtered.length === 0) { list.innerHTML = '<p class="empty-msg">Nessun risultato.</p>'; return; }
  filtered.forEach(ch => {
    const ri = channels.indexOf(ch);
    list.appendChild(makeItem(ch, ri));
  });
}

function makeItem(ch, ri) {
  const div = document.createElement("div");
  div.className = "channel-item" + (ri === currentIndex ? " active" : "");
  const logoHtml = ch.logo
    ? `<img class="channel-logo" src="${ch.logo}" onerror="this.style.display='none'" />`
    : `<div class="no-logo">üì∫</div>`;
  div.innerHTML = `${logoHtml}<div style="flex:1;overflow:hidden"><div class="ch-name">${ch.name}</div><div class="ch-cat">${ch.category}</div></div>`;
  div.onclick = () => selectChannel(ri);
  return div;
}

function selectChannel(index) {
  const ch = channels[index];
  if (!ch) return;
  currentIndex = index;
  renderChannels();
  document.getElementById("channel-overlay").textContent = "‚ñ∂ " + ch.name;
  document.getElementById("np-name").textContent = ch.name;
  document.getElementById("np-cat").textContent = ch.category;
  playHLS(ch.url, ch.name);
}

function playHLS(url, name) {
  const video = document.getElementById("video");
  setStatus("loading", "Connessione a " + name + "...");
  if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
  if (window.dashInstance) { window.dashInstance.reset(); window.dashInstance = null; }
  video.src = "";
  const isDASH = url.includes(".mpd");
  if (isDASH) {
    try {
      window.dashInstance = dashjs.MediaPlayer().create();
      window.dashInstance.initialize(video, url, true);
      window.dashInstance.on(dashjs.MediaPlayer.events.PLAYBACK_STARTED, () => setStatus("live", "‚ñ∂ " + name));
      window.dashInstance.on(dashjs.MediaPlayer.events.ERROR, () => setStatus("error", "Errore stream DASH"));
    } catch(e) { setStatus("error", "Errore DASH: " + e.message); }
  } else if (Hls.isSupported()) {
    hlsInstance = new Hls({ enableWorker: true, lowLatencyMode: true });
    hlsInstance.loadSource(url);
    hlsInstance.attachMedia(video);
     hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => { video.play().catch(() => {}); setStatus("live", "‚ñ∂ " + name); });
    hlsInstance.on(Hls.Events.ERROR, (e, data) => { if (data.fatal) setStatus("error", "Errore stream HLS"); });
  } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
    video.src = url;
    video.play().catch(() => {});
    setStatus("live", "‚ñ∂ " + name);
  } else {
    video.src = url;
    video.play().catch(() => { setStatus("error", "Formato non supportato"); });
    video.onplaying = () => setStatus("live", "‚ñ∂ " + name);
  }
}

function setStatus(type, msg) {
  document.getElementById("sdot").className = "sdot " + type;
  document.getElementById("stext").textContent = msg;
}

function reloadStream() {
  if (currentIndex >= 0) selectChannel(currentIndex);
  else loadM3U();
}

function openFullscreen() {
  const video = document.getElementById("video");
  if (video.requestFullscreen) video.requestFullscreen();
  else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
  else if (video.mozRequestFullScreen) video.mozRequestFullScreen();
}

function muteToggle() {
  const video = document.getElementById("video");
  video.muted = !video.muted;
  document.getElementById("mute-btn").textContent = video.muted ? "üîä Audio" : "üîá Muto";
}

function prevChannel() {
  if (currentIndex > 0) selectChannel(currentIndex - 1);
}

function nextChannel() {
  if (currentIndex < channels.length - 1) selectChannel(currentIndex + 1);
}

document.addEventListener("keydown", function(e) {
  switch(e.key) {
    case "ArrowDown": e.preventDefault(); moveFocus(1); break;
    case "ArrowUp": e.preventDefault(); moveFocus(-1); break;
    case "Enter":
    case " ":
      e.preventDefault();
      if (focusedIndex >= 0 && focusableItems[focusedIndex]) focusableItems[focusedIndex].click();
      break;
    case "ArrowRight": e.preventDefault(); nextChannel(); break;
    case "ArrowLeft": e.preventDefault(); prevChannel(); break;
    case "Backspace":
    case "XF86Back":
      e.preventDefault();
      document.getElementById("channel-list").focus();
      break;
    case "MediaPlayPause":
    case "p":
      e.preventDefault();
      const v = document.getElementById("video");
      v.paused ? v.play() : v.pause();
      break;
    case "MediaStop":
      e.preventDefault();
      document.getElementById("video").pause();
      break;
    case "MediaTrackNext": e.preventDefault(); nextChannel(); break;
    case "MediaTrackPrevious": e.preventDefault(); prevChannel(); break;
  }
});

function updateFocusable() {
  focusableItems = Array.from(document.querySelectorAll(".channel-item, .ctrl-btn, .cat-btn"));
}

function moveFocus(direction) {
  updateFocusable();
  if (focusableItems.length === 0) return;
  focusedIndex += direction;
  if (focusedIndex < 0) focusedIndex = 0;
  if (focusedIndex >= focusableItems.length) focusedIndex = focusableItems.length - 1;
  focusableItems.forEach(el => el.classList.remove("focused"));
  focusableItems[focusedIndex].classList.add("focused");
  focusableItems[focusedIndex].scrollIntoView({ block: "nearest" });
}
</script>
</body>
</html>










