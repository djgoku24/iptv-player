<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Player</title>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#000;color:#fff;font-family:'Segoe UI',sans-serif;display:flex;height:100vh;overflow:hidden}
        #sidebar{width:300px;background:#0d0d0d;display:flex;flex-direction:column;border-right:1px solid #1a1a1a;flex-shrink:0}
        #sidebar-header{padding:14px 16px;background:#0d0d0d;border-bottom:1px solid #1a1a1a;flex-shrink:0}
        #sidebar-header h2{font-size:1.1rem;color:#e94560;letter-spacing:1px;margin-bottom:8px}
        #search-input{width:100%;padding:8px 12px;background:#111;border:1px solid #222;border-radius:8px;color:#fff;font-size:.82rem;outline:none}
        #search-input:focus{border-color:#e94560}
        #cat-tabs{display:flex;overflow-x:auto;padding:8px 10px;gap:6px;border-bottom:1px solid #1a1a1a;flex-shrink:0}
        #cat-tabs::-webkit-scrollbar{height:3px}
        #cat-tabs::-webkit-scrollbar-thumb{background:#e94560;border-radius:2px}
        .cat-btn{background:#111;border:1px solid #222;color:#888;padding:4px 12px;border-radius:20px;font-size:.72rem;cursor:pointer;white-space:nowrap;transition:all .2s}
        .cat-btn:hover,.cat-btn.active{background:#e94560;border-color:#e94560;color:#fff}
        .cat-btn:focus{outline:2px solid #e94560;background:#e94560;color:#fff}
        #channel-list{flex:1;overflow-y:auto;padding:6px}
        #channel-list::-webkit-scrollbar{width:4px}
        #channel-list::-webkit-scrollbar-thumb{background:#e94560;border-radius:2px}
        .channel-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:background .2s;margin-bottom:2px}
        .channel-item:hover{background:#1a1a2e}
        .channel-item.active{background:#e94560}
        .channel-item:focus{outline:2px solid #e94560}
        .channel-logo{width:34px;height:34px;border-radius:6px;object-fit:contain;background:#111;flex-shrink:0}
        .no-logo{width:34px;height:34px;border-radius:6px;background:#1a1a2e;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
        .ch-name{font-size:.83rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .ch-cat{font-size:.68rem;color:#aaa}
        .channel-item.active .ch-cat{color:#ffcccc}
        .empty-msg{color:#444;font-size:.82rem;text-align:center;padding:20px 10px}
        #right{flex:1;display:flex;flex-direction:column;overflow:hidden}
        #player-screen{position:relative;flex:1;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
        video{width:100%;height:100%;object-fit:contain;background:#000}
        
        #player-overlay-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 1.1rem;
            font-weight: 500;
            text-align: center;
            z-index: 5;
            background: rgba(0,0,0,0.6);
            padding: 18px 30px;
            border-radius: 15px;
            pointer-events: none;
            border: 1px solid #333;
            line-height: 1.6;
        }
        #player-overlay-msg .sub {
            display: block;
            margin-top: 8px;
            font-size: 0.82rem;
            color: #ccc;
            letter-spacing: 0.2px;
        }
        #player-overlay-msg strong {
            color: #e94560;
        }

        #channel-overlay{position:absolute;top:14px;left:14px;background:rgba(0,0,0,.7);padding:5px 14px;border-radius:20px;font-size:.88rem;font-weight:600;pointer-events:none;z-index:10}
        #status-badge{position:absolute;top:14px;right:14px;display:flex;align-items:center;gap:6px;background:rgba(0,0,0,.7);padding:5px 12px;border-radius:20px;font-size:.75rem;pointer-events:none;z-index:10}
        .sdot{width:8px;height:8px;border-radius:50%;background:#555;flex-shrink:0}
        .sdot.live{background:#e94560;animation:pulse 1.2s infinite}
        .sdot.loading{background:#f0a500;animation:pulse .6s infinite}
        .sdot.error{background:#cc3333}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
        #controls{background:#0d0d0d;border-top:1px solid #1a1a1a;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-shrink:0;flex-wrap:wrap}
        #now-playing{flex:1;min-width:0}
        #now-playing .np-name{font-size:.9rem;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        #now-playing .np-cat{font-size:.72rem;color:#888}
        #ctrl-buttons{display:flex;gap:8px;flex-wrap:wrap}
        .ctrl-btn{background:#1a1a1a;border:1px solid #2a2a2a;color:#ccc;padding:8px 16px;border-radius:8px;font-size:.8rem;cursor:pointer;transition:all .2s;white-space:nowrap}
        .ctrl-btn:hover{background:#e94560;border-color:#e94560;color:#fff}
        .ctrl-btn:focus{outline:2px solid #e94560;background:#e94560;color:#fff}
        .focused{outline:2px solid #e94560 !important;background:#1e2a4a !important}
        #fs-bar{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.95));padding:20px 30px 16px;display:flex;align-items:center;gap:14px;z-index:9999;opacity:0;transition:opacity .4s;pointer-events:none}
        #fs-bar.show{opacity:1}
        #fs-bar-logo{width:42px;height:42px;border-radius:8px;object-fit:contain;background:#111}
        #fs-bar-info{flex:1}
        #fs-bar-name{font-size:1.2rem;font-weight:700;color:#fff}
        #fs-bar-cat{font-size:.8rem;color:#aaa;margin-top:2px}
        @media(max-width:800px){body{flex-direction:column}#sidebar{width:100%;height:240px;border-right:none;border-bottom:1px solid #1a1a1a}#controls{justify-content:center}}
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="sidebar-header">
            <h2>IPTV Player</h2>
            <input type="text" id="search-input" placeholder="üîç Cerca canale..." oninput="doSearch()">
        </div>
        <div id="cat-tabs"></div>
        <div id="channel-list">
            <p class="empty-msg">‚è≥ Caricamento lista...</p>
        </div>
    </div>

    <div id="right">
        <div id="player-screen">
            <div id="player-overlay-msg">
                üì∫ Seleziona un canale dalla lista
                <span class="sub">üéÆ Usa le <strong>frecce</strong> per navigare &nbsp;|&nbsp; ‚¨ÜÔ∏è‚¨áÔ∏è Scorri i canali &nbsp;|&nbsp; ‚úÖ Premi <strong>OK √ó 2</strong> per lo schermo intero</span>
            </div>
            <div id="channel-overlay" style="display:none"></div>
            <div id="status-badge">
                <div class="sdot" id="sdot"></div>
                <span id="stext">In attesa...</span>
            </div>
            <video id="video" autoplay playsinline></video>
        </div>

        <div id="controls">
            <div id="now-playing">
                <div class="np-name" id="np-name">‚Äî</div>
                <div class="np-cat" id="np-cat">‚Äî</div>
            </div>
            <div id="ctrl-buttons">
                <button class="ctrl-btn" onclick="prevChannel()">‚èÆ Prec</button>
                <button class="ctrl-btn" onclick="nextChannel()">‚è≠ Succ</button>
                <button class="ctrl-btn" id="mute-btn" onclick="muteToggle()">üîá Muto</button>
                <button class="ctrl-btn" onclick="reloadStream()">üîÑ Ricarica</button>
                <button class="ctrl-btn" onclick="openFullscreen()">‚õ∂ Fullscreen</button>
            </div>
        </div>
    </div>

    <div id="fs-bar">
        <img id="fs-bar-logo" src="" alt="">
        <div id="fs-bar-info">
            <div id="fs-bar-name"></div>
            <div id="fs-bar-cat"></div>
        </div>
        <div id="fs-bar-dot"></div>
    </div>

    <script>
        let channels = [];
        let currentIndex = -1;
        let currentCategory = "Tutti";
        let hlsInstance = null;
        let lastEnterTime = 0;

        window.addEventListener("load", () => {
            loadM3U();
            setTimeout(() => {
                const firstCat = document.querySelector(".cat-btn");
                if (firstCat) firstCat.focus();
            }, 1500);
        });

        function loadM3U() {
            setStatus("loading", "Caricamento lista...");
            fetch("ita.m3u?" + Date.now())
                .then(r => r.text())
                .then(text => {
                    parseM3U(text);
                    setStatus("live", channels.length + " canali caricati");
                })
                .catch(err => setStatus("error", "Errore M3U"));
        }

        function parseM3U(text) {
            channels = [];
            const lines = text.split("\n");
            let cur = null;
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith("#EXTINF")) {
                    cur = { name: line.split(",").pop(), category: "Generale", logo: "", url: "" };
                    const lg = line.match(/tvg-logo="([^"]*)"/);
                    if (lg) cur.logo = lg[1];
                    const gr = line.match(/group-title="([^"]*)"/);
                    if (gr) cur.category = gr[1];
                } else if (cur && line.startsWith("http")) {
                    cur.url = line;
                    channels.push(cur);
                    cur = null;
                }
            }
            renderCategoryTabs();
            renderChannels();
        }

        function renderCategoryTabs() {
            const tabs = document.getElementById("cat-tabs");
            const cats = ["Tutti", ...new Set(channels.map(c => c.category))];
            tabs.innerHTML = "";
            cats.forEach(cat => {
                const btn = document.createElement("button");
                btn.className = "cat-btn" + (cat === currentCategory ? " active" : "");
                btn.textContent = cat;
                btn.onclick = () => {
                    currentCategory = cat;
                    renderCategoryTabs();
                    renderChannels();
                };
                tabs.appendChild(btn);
            });
        }

        function renderChannels() {
            const list = document.getElementById("channel-list");
            list.innerHTML = "";
            const filtered = channels.filter(c => currentCategory === "Tutti" || c.category === currentCategory);
            filtered.forEach(ch => {
                const ri = channels.indexOf(ch);
                const div = document.createElement("div");
                div.className = "channel-item" + (ri === currentIndex ? " active" : "");
                div.tabIndex = 0;
                div.innerHTML = `
                    ${ch.logo ? `<img class="channel-logo" src="${ch.logo}" />` : `<div class="no-logo">üì∫</div>`}
                    <div style="flex:1;overflow:hidden">
                        <div class="ch-name">${ch.name}</div>
                        <div class="ch-cat">${ch.category}</div>
                    </div>
                `;
                div.onclick = () => selectChannel(ri);
                list.appendChild(div);
            });
        }

        function selectChannel(index) {
            const ch = channels[index];
            if (!ch) return;
            currentIndex = index;
            
            // Nasconde l'overlay iniziale
            const overlay = document.getElementById("player-overlay-msg");
            if (overlay) overlay.style.display = "none";
            
            document.getElementById("channel-overlay").style.display = "block";
            document.getElementById("channel-overlay").textContent = ch.name;
            document.getElementById("np-name").textContent = ch.name;
            document.getElementById("np-cat").textContent = ch.category;
            
            renderChannels();
            playStream(ch.url, ch.name);
        }

        function playStream(url, name) {
            const video = document.getElementById("video");
            setStatus("loading", "Caricamento...");
            if (hlsInstance) hlsInstance.destroy();

            if (url.includes(".m3u8")) {
                if (Hls.isSupported()) {
                    hlsInstance = new Hls();
                    hlsInstance.loadSource(url);
                    hlsInstance.attachMedia(video);
                    hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play();
                        setStatus("live", "In riproduzione");
                    });
                }
            } else {
                video.src = url;
                video.play();
                setStatus("live", "In riproduzione");
            }
        }

        function setStatus(type, msg) {
            document.getElementById("sdot").className = "sdot " + type;
            document.getElementById("stext").textContent = msg;
        }

        function doSearch() {
            const q = document.getElementById("search-input").value.toLowerCase();
            const items = document.querySelectorAll(".channel-item");
            items.forEach(item => {
                const name = item.querySelector(".ch-name").textContent.toLowerCase();
                item.style.display = name.includes(q) ? "flex" : "none";
            });
        }

        function muteToggle() {
            const v = document.getElementById("video");
            v.muted = !v.muted;
            document.getElementById("mute-btn").textContent = v.muted ? "üîä Audio" : "üîá Muto";
        }

        function reloadStream() { if (currentIndex >= 0) selectChannel(currentIndex); }
        function prevChannel() { if (currentIndex > 0) selectChannel(currentIndex - 1); }
        function nextChannel() { if (currentIndex < channels.length - 1) selectChannel(currentIndex + 1); }

        function openFullscreen() {
            const el = document.getElementById("player-screen");
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        }

        document.addEventListener("keydown", (e) => {
            const cats = document.querySelectorAll(".cat-btn");
            const items = Array.from(document.querySelectorAll(".channel-item")).filter(i => i.style.display !== "none");
            const ctrls = Array.from(document.querySelectorAll(".ctrl-btn"));
            const active = document.activeElement;

            if (e.key === "ArrowDown") {
                e.preventDefault();
                if (active.classList.contains("cat-btn")) {
                    if (items[0]) items[0].focus();
                } else if (active.classList.contains("channel-item")) {
                    const idx = items.indexOf(active);
                    if (items[idx + 1]) {
                        items[idx + 1].focus();
                    } else if (ctrls[0]) {
                        ctrls[0].focus();
                    }
                }
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                if (active.classList.contains("ctrl-btn")) {
                    if (items[items.length - 1]) items[items.length - 1].focus();
                } else {
                    const idx = items.indexOf(active);
                    if (idx > 0) items[idx - 1].focus();
                    else if (idx === 0) cats[0].focus();
                }
            } else if (e.key === "ArrowRight") {
                if (active.classList.contains("ctrl-btn")) {
                    const idx = ctrls.indexOf(active);
                    if (ctrls[idx + 1]) ctrls[idx + 1].focus();
                }
            } else if (e.key === "ArrowLeft") {
                if (active.classList.contains("ctrl-btn")) {
                    const idx = ctrls.indexOf(active);
                    if (idx > 0) ctrls[idx - 1].focus();
                }
            } else if (e.key === "Enter") {
                e.preventDefault();
                const now = Date.now();
                if (now - lastEnterTime < 400) {
                    openFullscreen();
                } else {
                    active.click();
                }
                lastEnterTime = now;
            }
        });
    </script>
</body>
</html>
